name: Python Code Quality and Tests

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "main" ]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy pytest pytest-cov

    # 1. BLACK - —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –≤—ã–≤–æ–¥–æ–º –∏ —Ü–≤–µ—Ç–æ–º
    - name: Check formatting with black
      run: |
        echo "=== BLACK CHECK (–ø–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥) ==="
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º diff –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è —á–∏—Ç–∞–µ–º–æ–≥–æ –≤—ã–≤–æ–¥–∞
        black --check --diff . 2>&1 | tee black_output.txt || true
        
        echo ""
        echo "=== –§–∞–π–ª—ã, —Ç—Ä–µ–±—É—é—â–∏–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ==="
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
        black --check . 2>&1 | grep -E "would reformat|Oh no!" | sed 's/.* //' || echo "‚úÖ –í—Å–µ —Ñ–∞–π–ª—ã –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ"
        
        echo ""
        echo "=== –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è: ==="
        echo "black ."

    # 2. ISORT - —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
    - name: Check import sorting with isort
      run: |
        echo "=== ISORT CHECK (–ø–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥) ==="
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å
        isort --check-only --diff . 2>&1 | tee isort_output.txt || true
        
        echo ""
        echo "=== –§–∞–π–ª—ã —Å –Ω–µ–æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∏–º–ø–æ—Ä—Ç–∞–º–∏: ==="
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
        isort --check-only . 2>&1 | grep -E "ERROR|FAIL" | awk '{print $2}' | sort -u || echo "‚úÖ –í—Å–µ –∏–º–ø–æ—Ä—Ç—ã –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ"
        
        echo ""
        echo "=== –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è: ==="
        echo "isort ."

    # 3. FLAKE8 - —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
    - name: Lint with flake8
      run: |
        echo "=== FLAKE8 CHECK ==="
        # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ—à–∏–±–∫–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ö
        echo "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—à–∏–±–æ–∫:"
        flake8 --count .
        
        echo ""
        echo "=== –î–µ—Ç–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥ –æ—à–∏–±–æ–∫: ==="
        flake8 --statistics .
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á–µ—Ç –≤ —Ñ–∞–π–ª
        flake8 . > flake8_report.txt 2>&1 || true
        
        echo ""
        echo "=== –ü–µ—Ä–≤—ã–µ 10 –æ—à–∏–±–æ–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å): ==="
        head -20 flake8_report.txt || echo "‚úÖ –û—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"

    # 4. MYPY - —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π –ø–æ —Ñ–∞–π–ª–∞–º
    - name: Check types with mypy
      run: |
        echo "=== MYPY CHECK ==="
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ü–≤–µ—Ç–Ω–æ–π –≤—ã–≤–æ–¥ –∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫—É
        mypy --ignore-missing-imports --color-output --no-error-summary .
        
        echo ""
        echo "=== –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—à–∏–±–æ–∫ –ø–æ —Ç–∏–ø–∞–º: ==="
        mypy --ignore-missing-imports . 2>&1 | grep -E "error:|note:" | sort | uniq -c | sort -nr || echo "‚úÖ –û—à–∏–±–æ–∫ —Ç–∏–ø–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"

    # 5. –¢–µ—Å—Ç—ã
    - name: Test with pytest
      run: |
        echo "=== PYTEST ==="
        pytest --cov=./ --cov-report=term-missing -v

    # 6. –°–æ–∑–¥–∞–µ–º –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
    - name: Generate summary report
      if: always()
      run: |
        echo "# üìä –û—Ç—á–µ—Ç –æ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–æ–¥–∞" > summary.md
        echo "## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è $(date)" >> summary.md
        echo "" >> summary.md
        
        # Black —Å—Ç–∞—Ç—É—Å
        echo "### üîß Black (—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)" >> summary.md
        if black --check . > /dev/null 2>&1; then
          echo "‚úÖ **–ü—Ä–æ–π–¥–µ–Ω–æ** - –í—Å–µ —Ñ–∞–π–ª—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω—ã" >> summary.md
        else
          echo "‚ùå **–ù–µ –ø—Ä–æ–π–¥–µ–Ω–æ** - –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ–∞–π–ª—ã —Ç—Ä–µ–±—É—é—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è" >> summary.md
          echo "" >> summary.md
          echo "**–§–∞–π–ª—ã –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**" >> summary.md
          black --check . 2>&1 | grep "would reformat" | sed 's/.* //' | while read file; do
            echo "- \`$file\`" >> summary.md
          done || true
        fi
        echo "" >> summary.md
        
        # isort —Å—Ç–∞—Ç—É—Å
        echo "### üì¶ isort (–∏–º–ø–æ—Ä—Ç—ã)" >> summary.md
        if isort --check-only . > /dev/null 2>&1; then
          echo "‚úÖ **–ü—Ä–æ–π–¥–µ–Ω–æ** - –í—Å–µ –∏–º–ø–æ—Ä—Ç—ã –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã" >> summary.md
        else
          echo "‚ùå **–ù–µ –ø—Ä–æ–π–¥–µ–Ω–æ** - –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —Ñ–∞–π–ª—ã —Ç—Ä–µ–±—É—é—Ç —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏–º–ø–æ—Ä—Ç–æ–≤" >> summary.md
          echo "" >> summary.md
          echo "**–§–∞–π–ª—ã –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**" >> summary.md
          isort --check-only . 2>&1 | grep "ERROR" | awk '{print $2}' | sort -u | while read file; do
            echo "- \`$file\`" >> summary.md
          done || true
        fi
        echo "" >> summary.md
        
        # flake8 —Å—Ç–∞—Ç—É—Å
        echo "### üßπ Flake8 (—Å—Ç–∏–ª—å –∫–æ–¥–∞)" >> summary.md
        FLAKE8_COUNT=$(flake8 --count . | tail -1)
        if [ "$FLAKE8_COUNT" = "0" ]; then
          echo "‚úÖ **–ü—Ä–æ–π–¥–µ–Ω–æ** - –û—à–∏–±–æ–∫ —Å—Ç–∏–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω–æ" >> summary.md
        else
          echo "‚ùå **–ù–µ –ø—Ä–æ–π–¥–µ–Ω–æ** - –ù–∞–π–¥–µ–Ω–æ $FLAKE8_COUNT –æ—à–∏–±–æ–∫" >> summary.md
        fi
        echo "" >> summary.md
        
        # mypy —Å—Ç–∞—Ç—É—Å
        echo "### ü¶Ü Mypy (—Ç–∏–ø–∏–∑–∞—Ü–∏—è)" >> summary.md
        if mypy --ignore-missing-imports . > /dev/null 2>&1; then
          echo "‚úÖ **–ü—Ä–æ–π–¥–µ–Ω–æ** - –û—à–∏–±–æ–∫ —Ç–∏–ø–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ" >> summary.md
        else
          echo "‚ùå **–ù–µ –ø—Ä–æ–π–¥–µ–Ω–æ** - –ù–∞–π–¥–µ–Ω—ã –æ—à–∏–±–∫–∏ —Ç–∏–ø–∏–∑–∞—Ü–∏–∏" >> summary.md
        fi
        
        echo "" >> summary.md
        echo "---" >> summary.md
        echo "*–û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ GitHub Actions*" >> summary.md
        
        # –í—ã–≤–æ–¥–∏–º –æ—Ç—á–µ—Ç –≤ –∫–æ–Ω—Å–æ–ª—å
        cat summary.md

    # 7. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –æ—Ç—á–µ—Ç—ã –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
    - name: Upload all reports as artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: code-quality-reports
        path: |
          summary.md
          black_output.txt
          isort_output.txt
          flake8_report.txt
          coverage.xml
